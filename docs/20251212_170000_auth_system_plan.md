# 認証システム実施計画書

## 基本情報
- **作成日時**: 2024年12月12日 17:00
- **プロジェクト**: 国土交通省 適正原価に関する実態調査
- **対象機能**: 認証システム構築

---

## 1. 概要

### 1.1 目的
調査回答者がアカウントを作成し、ダッシュボードから調査に回答できるシステムを構築する。

### 1.2 ユーザーフロー
```
トップページ
    ↓
[サインアップ] または [ログイン]
    ↓
サインアップページ
  - メールアドレス + パスワード登録
  - Google認証
  - Apple認証
    ↓
確認メール送信（SendGrid）
    ↓
メール内リンクをクリック
    ↓
ログインページ
    ↓
調査ダッシュボード
    ↓
[調査に回答する] ボタン
    ↓
調査回答ページ
```

---

## 2. 技術構成

### 2.1 使用技術
| 項目 | 技術 |
|------|------|
| 認証基盤 | Supabase Auth |
| メール認証 | Email + Password |
| ソーシャル認証 | Google OAuth, Apple OAuth |
| 確認メール送信 | SendGrid（Supabase経由） |
| セッション管理 | Supabase SSR |

### 2.2 必要な環境変数
```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=

# SendGrid（Supabaseで設定）
SENDGRID_API_KEY=

# Google OAuth（Supabaseダッシュボードで設定）
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=

# Apple OAuth（Supabaseダッシュボードで設定）
APPLE_CLIENT_ID=
APPLE_CLIENT_SECRET=
```

---

## 3. ページ構成

### 3.1 新規作成ページ
| ページ | パス | 説明 |
|--------|------|------|
| サインアップ | `/auth/signup` | 新規アカウント登録 |
| ログイン | `/auth/login` | ログイン |
| 認証コールバック | `/auth/callback` | OAuth認証後のリダイレクト先 |
| メール確認完了 | `/auth/confirm` | メール確認後のページ |
| ダッシュボード | `/dashboard` | 調査ダッシュボード（要認証） |

### 3.2 ディレクトリ構造
```
src/
├── app/
│   ├── auth/
│   │   ├── signup/
│   │   │   └── page.tsx        # サインアップページ
│   │   ├── login/
│   │   │   └── page.tsx        # ログインページ
│   │   ├── callback/
│   │   │   └── route.ts        # OAuth コールバック
│   │   └── confirm/
│   │       └── page.tsx        # メール確認完了
│   ├── dashboard/
│   │   └── page.tsx            # ダッシュボード（要認証）
│   └── survey/
│       └── page.tsx            # 調査回答ページ（要認証）
├── components/
│   ├── auth/
│   │   ├── SignUpForm.tsx      # サインアップフォーム
│   │   ├── LoginForm.tsx       # ログインフォーム
│   │   ├── SocialButtons.tsx   # Google/Appleボタン
│   │   └── AuthGuard.tsx       # 認証ガード
│   └── layout/
│       └── Header.tsx          # 認証状態表示ヘッダー
├── lib/
│   ├── supabase.ts             # クライアント
│   ├── supabase-server.ts      # サーバー用クライアント
│   └── auth.ts                 # 認証ヘルパー関数
└── middleware.ts               # 認証ミドルウェア
```

---

## 4. 実施手順

### Phase 1: Supabase設定（所要時間: 30分）
1. Supabaseプロジェクト作成
2. Authentication設定
   - Email認証を有効化
   - Google OAuth設定
   - Apple OAuth設定
3. SendGrid連携設定（SMTP設定）
4. 環境変数をVercelに設定

### Phase 2: 認証基盤構築（所要時間: 1時間）
1. Supabaseクライアント設定（SSR対応）
2. 認証ミドルウェア作成
3. 認証ヘルパー関数作成

### Phase 3: サインアップ機能（所要時間: 1時間）
1. サインアップページUI作成
2. メール+パスワード登録機能
3. Google認証ボタン実装
4. Apple認証ボタン実装
5. 確認メール送信連携

### Phase 4: ログイン機能（所要時間: 45分）
1. ログインページUI作成
2. メール+パスワードログイン
3. ソーシャルログイン
4. パスワードリセット機能

### Phase 5: ダッシュボード（所要時間: 45分）
1. 認証ガード実装
2. ダッシュボードUI作成
3. 調査回答ページへのリンク
4. ログアウト機能

### Phase 6: トップページ連携（所要時間: 30分）
1. ヘッダーに認証状態表示
2. ログイン/サインアップボタン追加
3. 認証済みユーザーはダッシュボードへリダイレクト

---

## 5. 画面設計

### 5.1 サインアップページ
```
┌─────────────────────────────────────┐
│           国土交通省                │
│     適正原価に関する実態調査        │
├─────────────────────────────────────┤
│                                     │
│        アカウント作成               │
│                                     │
│  ┌─────────────────────────────┐   │
│  │ メールアドレス              │   │
│  └─────────────────────────────┘   │
│  ┌─────────────────────────────┐   │
│  │ パスワード                  │   │
│  └─────────────────────────────┘   │
│  ┌─────────────────────────────┐   │
│  │ パスワード（確認）          │   │
│  └─────────────────────────────┘   │
│                                     │
│  [      アカウントを作成      ]    │
│                                     │
│  ──────── または ────────          │
│                                     │
│  [G] Googleで続ける                 │
│  [] Appleで続ける                  │
│                                     │
│  すでにアカウントをお持ちですか？   │
│  ログインはこちら                   │
│                                     │
└─────────────────────────────────────┘
```

### 5.2 ダッシュボード
```
┌─────────────────────────────────────┐
│ 国土交通省    [ユーザー名] [ログアウト]│
├─────────────────────────────────────┤
│                                     │
│  ようこそ、○○様                    │
│                                     │
│  ┌───────────────────────────────┐ │
│  │  調査回答状況                 │ │
│  │  ステータス: 未回答           │ │
│  │                               │ │
│  │  [   調査に回答する   ]       │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │  動画解説                     │ │
│  │  調査の目的や回答方法を       │ │
│  │  動画で確認できます           │ │
│  │                               │ │
│  │  [   動画を見る   ]           │ │
│  └───────────────────────────────┘ │
│                                     │
└─────────────────────────────────────┘
```

---

## 6. セキュリティ考慮事項

1. **パスワード要件**
   - 最低8文字以上
   - 英数字混合推奨

2. **セッション管理**
   - HTTPOnly Cookie使用
   - CSRF対策

3. **認証ガード**
   - ミドルウェアで保護ルートをチェック
   - 未認証ユーザーはログインページへリダイレクト

4. **メール確認**
   - サインアップ後、メール確認が完了するまでログイン不可

---

## 7. Supabase設定手順（詳細）

### 7.1 プロジェクト作成
1. https://supabase.com にアクセス
2. 新規プロジェクト作成
3. プロジェクト名: `mlit-cost-survey`
4. リージョン: `Northeast Asia (Tokyo)`

### 7.2 Authentication設定
1. Authentication > Providers
2. Email: 有効化
3. Google: 有効化（Client ID/Secretを設定）
4. Apple: 有効化（Client ID/Secretを設定）

### 7.3 SendGrid連携（SMTP）
1. Authentication > Email Templates
2. SMTP Settings:
   - Host: `smtp.sendgrid.net`
   - Port: `587`
   - Username: `apikey`
   - Password: `your_sendgrid_api_key`

### 7.4 Redirect URLs設定
```
http://localhost:3000/auth/callback
https://mlitcostsurvey.vercel.app/auth/callback
```

---

## 8. 実施スケジュール

| Phase | 内容 | 所要時間 |
|-------|------|----------|
| Phase 1 | Supabase設定 | 30分 |
| Phase 2 | 認証基盤構築 | 1時間 |
| Phase 3 | サインアップ機能 | 1時間 |
| Phase 4 | ログイン機能 | 45分 |
| Phase 5 | ダッシュボード | 45分 |
| Phase 6 | トップページ連携 | 30分 |
| **合計** | | **約4時間30分** |

---

## 9. 次のステップ

1. Supabaseプロジェクトを作成し、認証情報を取得
2. Google Cloud Consoleで OAuth クライアントIDを作成
3. Apple Developer でSign in with Appleを設定
4. SendGrid APIキーを取得
5. 環境変数を設定し、実装開始

---

*最終更新: 2024年12月12日 17:00*
